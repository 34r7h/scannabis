"use strict";angular.module("scannabis",["ngAnimate","ngAria","ngResource","ngTouch","ui.router","ngSanitize","firebase","uploader"]),angular.module("scannabis").directive("auth",function(){return{templateUrl:"scripts/directives/auth/auth-d.html",restrict:"EA"}}),angular.module("scannabis").directive("coin",function(){return{templateUrl:"scripts/directives/coin/coin-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("delivery",function(){return{templateUrl:"scripts/directives/delivery/delivery-d.html",restrict:"EA"}}),angular.module("scannabis").directive("dna",function(){return{templateUrl:"scripts/directives/dna/dna-d.html",restrict:"EA"}}),angular.module("scannabis").directive("job",function(){return{templateUrl:"scripts/directives/job/job-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("jobs",function(){return{templateUrl:"scripts/directives/jobs/jobs-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("news",function(){return{templateUrl:"scripts/directives/news/news-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("product",function(){return{templateUrl:"scripts/directives/product/product-d.html",restrict:"EA"}}),angular.module("scannabis").directive("products",function(){return{templateUrl:"scripts/directives/products/products-d.html",restrict:"EA"}}),angular.module("scannabis").directive("reviews",function(){return{templateUrl:"scripts/directives/reviews/reviews-d.html",restrict:"EA"}}),angular.module("scannabis").directive("scannabis",function(){return{templateUrl:"scripts/directives/scannabis/scannabis-d.html",restrict:"EA"}}),angular.module("scannabis").directive("shop",function(){return{templateUrl:"scripts/directives/shop/shop-d.html",restrict:"EA"}}),angular.module("scannabis").directive("users",function(){return{templateUrl:"scripts/directives/users/users-d.html",restrict:"EA"}});var online=navigator.onLine,fb=Firebase,fbRef="https://scannabis.firebaseio.com/",localForage=localforage,products={},fbDb=new fb(fbRef),db={users:fbDb.child("users")};angular.module("scannabis").factory("Data",["$firebaseObject","$firebaseArray","$firebaseAuth","$sce","$window","$state",function(e,t,a,s,r,n){var i={methods:{},data:{},auth:{},test:{},local:{}};return localForage.getItem("products",function(e,t){i.data.products=t,n.reload()}),localForage.getItem("my-products",function(e,t){i.data.myProducts=t,n.reload()}),localForage.getItem("auth",function(e,t){i.data.auth=t,n.reload(),i.auth=a(fbDb).$getAuth()}),i.methods={sanitize:function(e){return s.trustAsResourceUrl(e)},getData:function(){i.test.users=e(db.users),i.test.users.$loaded().then(function(e){i.test.products=[],i.test.myProducts=[],angular.forEach(e,function(e,t){angular.forEach(e["public"].products,function(e,a){e.user=t,e.id=a,i.test.products.push(e),i.data.auth.uid===t?i.test.myProducts.push(e):null})}),i.data=i.test,localForage.setItem("products",i.test.products),localForage.setItem("my-products",i.test.myProducts)})},login:function(e){var t=a(fbDb);t.$authWithPassword({email:e.email,password:e.pass}).then(function(e){i.auth=e,localForage.setItem("auth",e),i.methods.getData(),n.go("scannabis.market")})["catch"](function(e){console.error("Authentication failed:",e)})},register:function(t){var s=new fb(fbRef),r=a(s);r.$createUser({email:t.email,password:t.pass}).then(function(e){return console.log("User "+e.uid+" created successfully!"),r.$authWithPassword({email:t.email,password:t.pass})}).then(function(a){var r=s.child("users");e(r).$loaded().then(function(e){t.pass=null,e[a.uid]=t,e.$save()});i.methods.getData()})["catch"](function(e){console.error("Error: ",e)})},logout:function(){var e=new fb(fbRef),t=a(e);t.$unauth(),i.data.users={},i.auth={},r.localForage.clear()},save:function(t,a,s){console.log("saving data");var r=fbRef+t+"/"+a,n=new fb(r),i=e(n);i.$value=angular.copy(s),i.$save()},add:function(e,a,s){i.methods.getData();var r=s?fbRef+s+"/"+e:fbRef+"users/"+i.auth.uid+"/public/"+e,n=new fb(r),o=t(n);o.$add(a).then(function(){i.methods.getData()})},remove:function(t,a){var s=fbRef+"users/"+i.auth.uid+"/public/"+t+"/"+a;console.log("removeRef",s);var r=new fb(s),n=e(r);n.$remove()}},i.methods.getData(),i}]);var uploader=angular.module("uploader",["ngSanitize"]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//)}]);uploader.provider("AWSControl",function(){var e=[];this.yeah="Hi",this.dataImg="",this.$get=["$q","$rootScope","$firebase","$sce",function(t,a,s,r){return{dataImg:this.dataImg,mimes:e,upload:function(e,r){console.log("file: ",e),console.log("key: ",r);var n=r;a.dataImg=e;var i=Date.now();r=r.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),r=r+"-"+i+".png";var o=-1;if(angular.forEach(this.mimes,function(e,t){-1===o&&(o=t)}),-1===o)return!1;var c=t.defer(),l=this.mimes[o];if("s3"===l.host){var u={Key:r,ContentType:e.type,Body:e};AWS.config.update({accessKeyId:l.accessKeyId,secretAccessKey:l.secretAccessKey}),AWS.config.region=l.region,AWS.config.host=l.host;var d=new AWS.S3({params:{Bucket:l.Bucket}});return d.putObject(u,function(e,t){if(e)a.$broadcast("AWSUploadError"),c.reject(e);else{a.$broadcast("AWSUploadSuccess"),c.resolve(t),a.newImage="https://"+AWS.config.host+"-"+AWS.config.region+".amazonaws.com/"+l.Bucket+"/"+encodeURIComponent(r),a.mediaTitle=n,a.mediaThumbs={},a.mediaDescription="Vancouver Metalwork",a.mediaTitle=a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),a.mediaTags=[n];var i=new Firebase("https://metal.firebaseio.com/media"),o=s(i);o.$push({mediaThumbs:a.smallMedia,mediaURL:a.newImage,mediaTitle:a.mediaTitle,mediaLink:a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),mediaDescription:a.mediaDescription,mediaTags:a.mediaTags}).then(function(e){var t=e.name(),r=new Firebase("https://metal.firebaseio.com/index/media"),n=s(r);n.$set(a.mediaTitle,t)})}}),c.promise}alert("No handler")}}}]}),uploader.directive("uploader",["AWSControl","$rootScope","$sce",function(e,t,a){return{replace:!0,scope:{},template:'<form name="uploading" novalidate><input class="well" type="file" multiple="multiple" id="yourInput" ng-blur="upload()"/><!--<button class="btn btn-behance" id="upIt" data-ng-click="upload()">Upload</button>--></form>',restrict:"E",link:function(e,a){e.upload=function(){var a=document.getElementById("yourInput").files;console.log("files",a),t.media=[],angular.forEach(a,function(a,s){var r=s;t.media[r]={},console.log("for each file",a),e.reader=new FileReader(a),e.reader.onload=function(a){return e.reader.readAsDataURL(a),function(e){console.log("-- RESULT",e.target.result,"-- NAME:",a.name);var s=new Image;s.src=e.target.result,t.media[r].full=s.src}}(a)})}}}}]),angular.module("scannabis").config(["$stateProvider","$urlRouterProvider","$compileProvider",function(e,t,a){a.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.state("scannabis.test",{url:"test",template:"<scannabis></scannabis>"}).state("scannabis",{url:"/",template:"<scannabis></scannabis>",controller:["$scope","Data","$state",function(e,t,a){e.data=t,e.state=a,e.local=t.local}]}).state("scannabis.market",{url:"market",template:"<ui-view></ui-view><shop></shop><reviews></reviews>"}).state("scannabis.market.location",{url:"/:location"}).state("scannabis.market.location.shop",{url:"/:shop"}).state("scannabis.market.product",{url:"/:user/:product",template:"<product></product><reviews></reviews>"}).state("scannabis.auth",{url:"auth",template:"<auth></auth>"}).state("scannabis.pos",{url:"pos",template:"<products></products><reviews></reviews>"}).state("scannabis.strains",{url:"strains",template:"<dna></dna>"}).state("scannabis.delivery",{url:"delivery",template:"<delivery></delivery>"}).state("scannabis.news",{url:"news",template:"<news></news>"}).state("scannabis.users",{url:"users",template:"<users></users>"}).state("scannabis.coin",{url:"coins",template:"<coin></coin>"}).state("scannabis.jobs",{url:"jobs",template:"<jobs></jobs>"}).state("scannabis.jobs.job",{url:"/:job",template:"<job></job>"}).state("scannabis.jobs.hires",{url:"jobs",template:"<jobs></jobs>"}),t.otherwise("/")}]);