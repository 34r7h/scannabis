"use strict";angular.module("scannabis",["ngAnimate","ngAria","ngResource","ngTouch","ui.router","ngSanitize","firebase"]),angular.module("scannabis").directive("auth",function(){return{templateUrl:"scripts/directives/auth/auth-d.html",restrict:"EA"}}),angular.module("scannabis").directive("coin",function(){return{templateUrl:"scripts/directives/coin/coin-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("delivery",function(){return{templateUrl:"scripts/directives/delivery/delivery-d.html",restrict:"EA"}}),angular.module("scannabis").directive("dna",function(){return{templateUrl:"scripts/directives/dna/dna-d.html",restrict:"EA"}}),angular.module("scannabis").directive("job",function(){return{templateUrl:"scripts/directives/job/job-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("jobs",function(){return{templateUrl:"scripts/directives/jobs/jobs-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("news",function(){return{templateUrl:"scripts/directives/news/news-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("product",function(){return{templateUrl:"scripts/directives/product/product-d.html",restrict:"EA"}}),angular.module("scannabis").directive("products",function(){return{templateUrl:"scripts/directives/products/products-d.html",restrict:"EA"}}),angular.module("scannabis").directive("reviews",function(){return{templateUrl:"scripts/directives/reviews/reviews-d.html",restrict:"EA"}}),angular.module("scannabis").directive("scannabis",function(){return{templateUrl:"scripts/directives/scannabis/scannabis-d.html",restrict:"EA"}}),angular.module("scannabis").directive("shop",function(){return{templateUrl:"scripts/directives/shop/shop-d.html",restrict:"EA"}}),angular.module("scannabis").directive("users",function(){return{templateUrl:"scripts/directives/users/users-d.html",restrict:"EA"}});var date=Date.now(),online=navigator.onLine,fb=Firebase,fbRef="https://scannabis.firebaseio.com/",localForage=localforage,products={},fbDb=new fb(fbRef),db={users:fbDb.child("users"),products:fbDb.child("products"),images:fbDb.child("images")};angular.module("scannabis").factory("Data",["$firebaseObject","$firebaseArray","$firebaseAuth","$sce","$window","$state","$rootScope",function(e,t,a,n,s,r,i){var o={methods:{},data:{},auth:{},test:{},local:{}};return o.test.date=date,localForage.getItem("products",function(e,t){o.test.products=t,r.reload()}),localForage.getItem("images",function(e,t){o.test.images=t,r.reload()}),localForage.getItem("users",function(e,t){o.test.users=t,r.reload()}),localForage.getItem("auth",function(e,t){o.auth=t,o.auth=a(fbDb).$getAuth(),r.reload()}),o.methods={getImage:function(t){var a=o.test.images[t]||e(db.images.child(t));return a},getEntry:function(t,a){var n=o.test[t][a]||e(db[t].child(a));return n},sanitize:function(e){return n.trustAsResourceUrl(e)},getData:function(){var t=e(db.images);t.$loaded().then(function(e){o.test.images=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("images",t)});var a=e(db.products);a.$loaded().then(function(e){o.test.products=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("products",t)});var n=e(db.users);n.$loaded().then(function(e){o.test.users=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("users",t)})},login:function(e){var t=a(fbDb);t.$authWithPassword({email:e.email,password:e.pass}).then(function(e){o.auth=e,localForage.setItem("auth",e),o.methods.getData(),r.go("scannabis.market")})["catch"](function(e){console.error("Authentication failed:",e)})},register:function(t){var n=new fb(fbRef),s=a(n);s.$createUser({email:t.email,password:t.pass}).then(function(e){return console.log("User "+e.uid+" created successfully!"),s.$authWithPassword({email:t.email,password:t.pass})}).then(function(a){var s=n.child("users");e(s).$loaded().then(function(e){t.pass=null,t.validated={licensing:!1,authorization:!1,identification:!1,profile:!1},e[a.uid]=t,e.$save(),i.secure=null});o.methods.getData()})["catch"](function(e){console.error("Error: ",e)})},logout:function(){var e=new fb(fbRef),t=a(e);t.$unauth(),o.data.users={},o.auth={},localForage.clear()},save:function(t,a,n){console.log("saving data",arguments);var s=fbRef+t;console.log(s);var r=new fb(s);e(r).$loaded().then(function(e){console.log(e),e[a]=n,e.$value=angular.copy(n),e.$save()})},add:function(e,a,n){o.methods.getData();var s=n?fbRef+n+"/"+e:fbRef+"users/"+o.auth.uid+"/public/"+e,r=new fb(s),i=t(r);i.$add(a).then(function(){o.methods.getData()})},addNew:function(a,n,s){o.methods.getData();var r=s?fbRef+s+"/"+a:fbRef+"users/"+o.auth.uid+"/public/"+a,i=fbRef+a,c=new fb(i),l=new fb(r),u=t(c);u.$add(n).then(function(t){var a=t.key();e(l).$loaded().then(function(e){e[a]=!0,e.$save()});o.methods.getData()})},remove:function(t,a){var n=fbRef+"users/"+o.auth.uid+"/public/"+t+"/"+a;console.log("removeRef",n);var s=new fb(n),i=e(s);i.$remove(),r.reload()}},o.methods.getData(),o}]),angular.module("scannabis").directive("uploader",["$rootScope","$sce","$firebaseArray","$firebaseObject","Data",function(e,t,a,n,s){return{replace:!0,scope:{name:"@name",pass:"=pass"},template:'<form id="{{name}}-form" novalidate><button type="button" class="tertiary"<!-- data-ng-click="upload()"-->><input class="well file-input" type="file" id="{{name}}" ng-blur="upload()" /></button></form>',restrict:"E",link:function(t,r){t.upload=function(){console.log(t,s),t.pass?t.pass.media=null:e.media=null;var r="identification"===t.name||"authorization"===t.name||"licensing"===t.name||"profile"===t.name?(e.secure?null:e.secure={raw:{}},"https://scannabis.firebaseio.com/secure/images"):"https://scannabis.firebaseio.com/images",i="identification"===t.name||"authorization"===t.name||"licensing"===t.name||"profile"===t.name?"https://scannabis.firebaseio.com/superuser/secure/images":"https://scannabis.firebaseio.com/users/"+s.auth.uid+"/public/images",o=new Firebase(r),c=new Firebase(i),l=a(o),u=n(c),d=document.getElementById(t.name).files;console.log("files",d),angular.forEach(d,function(a){t.reader=new FileReader(a),t.reader.onload=function(a){return t.reader.readAsDataURL(a),function(n){console.log("-- RESULT",n.target.result,"-- NAME:",a.name);var s=new Image;s.src=n.target.result,l.$add(s.src).then(function(n){"identification"===t.name||"authorization"===t.name||"licensing"===t.name||"profile"===t.name?(e.secure.raw[t.name]=s.src,u[t.name]=n.key(),e.secure[t.name]=n.key()):u[JSON.stringify(a.name.replace(/\./g,"``"))]=n.key(),u.$save(),console.log(n.key()),t.pass?t.pass.media=n.key():e.media=n.key(),document.getElementById(t.name).value=null})}}(a)})}}}}]);var uploader=angular.module("uploader",["ngSanitize"]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//)}]);uploader.provider("AWSControl",function(){var e=[];this.yeah="Hi",this.dataImg="",this.$get=["$q","$rootScope","$firebaseArray","$sce",function(t,a,n,s){return{dataImg:this.dataImg,mimes:e,upload:function(e,n){console.log("file: ",e),console.log("key: ",n);var s=n;a.dataImg=e;var r=Date.now();n=n.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),n=n+"-"+r+".png";var i=-1;if(angular.forEach(this.mimes,function(e,t){-1===i&&(i=t)}),-1===i)return!1;var o=t.defer(),c=this.mimes[i];if("s3"===c.host){var l={Key:n,ContentType:e.type,Body:e};AWS.config.update({accessKeyId:c.accessKeyId,secretAccessKey:c.secretAccessKey}),AWS.config.region=c.region,AWS.config.host=c.host;var u=new AWS.S3({params:{Bucket:c.Bucket}});return u.putObject(l,function(e,t){if(e)a.$broadcast("AWSUploadError"),o.reject(e);else{a.$broadcast("AWSUploadSuccess"),o.resolve(t),a.newImage="https://"+AWS.config.host+"-"+AWS.config.region+".amazonaws.com/"+c.Bucket+"/"+encodeURIComponent(n),a.mediaTitle=s,a.mediaThumbs={},a.mediaDescription="Vancouver Metalwork",a.mediaTitle=a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),a.mediaTags=[s];var r=new Firebase("https://metal.firebaseio.com/media"),i=$firebase(r);i.$push({mediaThumbs:a.smallMedia,mediaURL:a.newImage,mediaTitle:a.mediaTitle,mediaLink:a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),mediaDescription:a.mediaDescription,mediaTags:a.mediaTags}).then(function(e){var t=e.name(),n=new Firebase("https://metal.firebaseio.com/index/media"),s=$firebase(n);s.$set(a.mediaTitle,t)})}}),o.promise}alert("No handler")}}}]}),uploader.directive("uploader",["AWSControl","$rootScope","$sce","$firebaseArray",function(e,t,a,n){return{replace:!0,scope:{},template:'<form name="uploading" novalidate><input class="well" type="file" id="yourInput"/><button type="button" class="btn btn-behance" id="upIt" data-ng-click="upload()">Upload</button></form>',restrict:"E",link:function(e,a){e.upload=function(){var a="https://scannabis.firebaseio.com/images",s=(localforage,new Firebase(a)),r=n(s),i=document.getElementById("yourInput").files;console.log("files",i),angular.forEach(i,function(a){console.log("for each file",a),e.reader=new FileReader(a),e.reader.onload=function(a){return e.reader.readAsDataURL(a),function(e){console.log("-- RESULT",e.target.result,"-- NAME:",a.name);var n=new Image;n.src=e.target.result,r.$add(n.src).then(function(e){console.log(e.key()),t.media=e.key(),document.getElementById("yourInput").value=null})}}(a)})}}}}]),angular.module("scannabis").config(["$stateProvider","$urlRouterProvider","$compileProvider",function(e,t,a){a.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.state("scannabis.test",{url:"test",template:"<scannabis></scannabis>"}).state("scannabis",{url:"/",template:"<scannabis></scannabis>",controller:["$scope","Data","$state",function(e,t,a){e.data=t,e.state=a,e.local=t.local}]}).state("scannabis.market",{url:"market",template:"<ui-view></ui-view><shop></shop><reviews></reviews>"}).state("scannabis.market.location",{url:"/:location"}).state("scannabis.market.location.shop",{url:"/:shop"}).state("scannabis.market.product",{url:"/:user/:product",template:"<product></product><reviews></reviews>"}).state("scannabis.auth",{url:"auth",template:"<auth></auth>"}).state("scannabis.pos",{url:"pos",template:"<products></products><reviews></reviews>"}).state("scannabis.strains",{url:"strains",template:"<dna></dna>"}).state("scannabis.delivery",{url:"delivery",template:"<delivery></delivery>"}).state("scannabis.news",{url:"news",template:"<news></news>"}).state("scannabis.users",{url:"users",template:"<users></users>"}).state("scannabis.coins",{url:"coins",template:"<coin></coin>"}).state("scannabis.jobs",{url:"jobs",template:"<jobs></jobs>"}).state("scannabis.jobs.job",{url:"/:job",template:"<job></job>"}).state("scannabis.jobs.hires",{url:"jobs",template:"<jobs></jobs>"}),t.otherwise("/")}]);