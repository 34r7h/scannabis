"use strict";angular.module("scannabis",["ngAnimate","ngAria","ngResource","ngTouch","ui.router","ngSanitize","firebase"]),angular.module("scannabis").directive("auth",function(){return{templateUrl:"scripts/directives/auth/auth-d.html",restrict:"EA"}}),angular.module("scannabis").directive("coin",function(){return{templateUrl:"scripts/directives/coin/coin-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("delivery",function(){return{templateUrl:"scripts/directives/delivery/delivery-d.html",restrict:"EA"}}),angular.module("scannabis").directive("dna",function(){return{templateUrl:"scripts/directives/dna/dna-d.html",restrict:"EA"}}),angular.module("scannabis").directive("job",function(){return{templateUrl:"scripts/directives/job/job-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("jobs",function(){return{templateUrl:"scripts/directives/jobs/jobs-d.html",restrict:"EA",link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("news",function(){return{templateUrl:"scripts/directives/news/news-d.html",restrict:"EA",scope:{},link:function(e,t,a){},controller:["$scope",function(e){}]}}),angular.module("scannabis").directive("product",function(){return{templateUrl:"scripts/directives/product/product-d.html",restrict:"EA"}}),angular.module("scannabis").directive("products",function(){return{templateUrl:"scripts/directives/products/products-d.html",restrict:"EA"}}),angular.module("scannabis").directive("reviews",function(){return{templateUrl:"scripts/directives/reviews/reviews-d.html",restrict:"EA"}}),angular.module("scannabis").directive("scannabis",function(){return{templateUrl:"scripts/directives/scannabis/scannabis-d.html",restrict:"EA"}}),angular.module("scannabis").directive("shop",function(){return{templateUrl:"scripts/directives/shop/shop-d.html",restrict:"EA"}}),angular.module("scannabis").directive("users",function(){return{templateUrl:"scripts/directives/users/users-d.html",restrict:"EA"}});var online=navigator.onLine,fb=Firebase,fbRef="https://scannabis.firebaseio.com/",localForage=localforage,products={},fbDb=new fb(fbRef),db={users:fbDb.child("users"),products:fbDb.child("products"),images:fbDb.child("images")};angular.module("scannabis").factory("Data",["$firebaseObject","$firebaseArray","$firebaseAuth","$sce","$window","$state",function(e,t,a,s,n,r){var i={methods:{},data:{},auth:{},test:{},local:{}};return localForage.getItem("products",function(e,t){i.test.products=t,r.reload()}),localForage.getItem("images",function(e,t){i.test.images=t,r.reload()}),localForage.getItem("users",function(e,t){i.test.users=t,r.reload()}),localForage.getItem("auth",function(e,t){i.auth=t,i.auth=a(fbDb).$getAuth(),r.reload()}),i.methods={getImage:function(t){var a=i.test.images[t]||e(db.images.child(t));return a},getEntry:function(t,a){var s=i.test[t][a]||e(db[t].child(a));return s},sanitize:function(e){return s.trustAsResourceUrl(e)},getData:function(){var t=e(db.images);t.$loaded().then(function(e){i.test.images=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("images",t)});var a=e(db.products);a.$loaded().then(function(e){i.test.products=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("products",t)});var s=e(db.users);s.$loaded().then(function(e){i.test.users=e;var t={};angular.forEach(e,function(e,a){t[a]=e}),localForage.setItem("users",t)})},login:function(e){var t=a(fbDb);t.$authWithPassword({email:e.email,password:e.pass}).then(function(e){i.auth=e,localForage.setItem("auth",e),i.methods.getData(),r.go("scannabis.market")})["catch"](function(e){console.error("Authentication failed:",e)})},register:function(t){var s=new fb(fbRef),n=a(s);n.$createUser({email:t.email,password:t.pass}).then(function(e){return console.log("User "+e.uid+" created successfully!"),n.$authWithPassword({email:t.email,password:t.pass})}).then(function(a){var n=s.child("users");e(n).$loaded().then(function(e){t.pass=null,e[a.uid]=t,e.$save()});i.methods.getData()})["catch"](function(e){console.error("Error: ",e)})},logout:function(){var e=new fb(fbRef),t=a(e);t.$unauth(),i.data.users={},i.auth={},localForage.clear()},save:function(t,a,s){console.log("saving data");var n=fbRef+t;console.log(n);var r=new fb(n);e(r).$loaded().then(function(e){e[a]=s,e.$save()})},add:function(e,a,s){i.methods.getData();var n=s?fbRef+s+"/"+e:fbRef+"users/"+i.auth.uid+"/public/"+e,r=new fb(n),o=t(r);o.$add(a).then(function(){i.methods.getData()})},addNew:function(a,s,n){i.methods.getData();var r=n?fbRef+n+"/"+a:fbRef+"users/"+i.auth.uid+"/public/"+a,o=fbRef+a,c=new fb(o),l=new fb(r),u=t(c);u.$add(s).then(function(t){var a=t.key();e(l).$loaded().then(function(e){e[a]=!0,e.$save()});i.methods.getData()})},remove:function(t,a){var s=fbRef+"users/"+i.auth.uid+"/public/"+t+"/"+a;console.log("removeRef",s);var n=new fb(s),o=e(n);o.$remove(),r.reload()}},i.methods.getData(),i}]),angular.module("scannabis").directive("uploader",["$rootScope","$sce","$firebaseArray","$firebaseObject","Data",function(e,t,a,s,n){return{replace:!0,scope:{name:"@name",pass:"=pass"},template:'<form id="{{name}}-form" novalidate><input class="well" type="file" id="{{name}}"/><button type="button" class="btn btn-behance" id="upIt" data-ng-click="upload()">Upload</button></form>',restrict:"E",link:function(t,r){t.upload=function(){console.log(t,n),t.pass?t.pass.media=null:e.media=null;var r="https://scannabis.firebaseio.com/images",i="https://scannabis.firebaseio.com/users/"+n.auth.uid+"/public/images",o=new Firebase(r),c=new Firebase(i),l=a(o),u=s(c),d=document.getElementById(t.name).files;console.log("files",d),angular.forEach(d,function(a){t.reader=new FileReader(a),t.reader.onload=function(a){return t.reader.readAsDataURL(a),function(s){console.log("-- RESULT",s.target.result,"-- NAME:",a.name);var n=new Image;n.src=s.target.result,l.$add(n.src).then(function(s){u[JSON.stringify(a.name.replace(/\./g,"``bar``"))]=s.key(),u.$save(),console.log(s.key()),t.pass?t.pass.media=s.key():e.media=s.key(),document.getElementById(t.name).value=null})}}(a)})}}}}]);var uploader=angular.module("uploader",["ngSanitize"]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//)}]);uploader.provider("AWSControl",function(){var e=[];this.yeah="Hi",this.dataImg="",this.$get=["$q","$rootScope","$firebaseArray","$sce",function(t,a,s,n){return{dataImg:this.dataImg,mimes:e,upload:function(e,s){console.log("file: ",e),console.log("key: ",s);var n=s;a.dataImg=e;var r=Date.now();s=s.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),s=s+"-"+r+".png";var i=-1;if(angular.forEach(this.mimes,function(e,t){-1===i&&(i=t)}),-1===i)return!1;var o=t.defer(),c=this.mimes[i];if("s3"===c.host){var l={Key:s,ContentType:e.type,Body:e};AWS.config.update({accessKeyId:c.accessKeyId,secretAccessKey:c.secretAccessKey}),AWS.config.region=c.region,AWS.config.host=c.host;var u=new AWS.S3({params:{Bucket:c.Bucket}});return u.putObject(l,function(e,t){if(e)a.$broadcast("AWSUploadError"),o.reject(e);else{a.$broadcast("AWSUploadSuccess"),o.resolve(t),a.newImage="https://"+AWS.config.host+"-"+AWS.config.region+".amazonaws.com/"+c.Bucket+"/"+encodeURIComponent(s),a.mediaTitle=n,a.mediaThumbs={},a.mediaDescription="Vancouver Metalwork",a.mediaTitle=a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),a.mediaTags=[n];var r=new Firebase("https://metal.firebaseio.com/media"),i=$firebase(r);i.$push({mediaThumbs:a.smallMedia,mediaURL:a.newImage,mediaTitle:a.mediaTitle,mediaLink:a.mediaTitle.toLowerCase().replace(/'+/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,""),mediaDescription:a.mediaDescription,mediaTags:a.mediaTags}).then(function(e){var t=e.name(),s=new Firebase("https://metal.firebaseio.com/index/media"),n=$firebase(s);n.$set(a.mediaTitle,t)})}}),o.promise}alert("No handler")}}}]}),uploader.directive("uploader",["AWSControl","$rootScope","$sce","$firebaseArray",function(e,t,a,s){return{replace:!0,scope:{},template:'<form name="uploading" novalidate><input class="well" type="file" id="yourInput"/><button type="button" class="btn btn-behance" id="upIt" data-ng-click="upload()">Upload</button></form>',restrict:"E",link:function(e,a){e.upload=function(){var a="https://scannabis.firebaseio.com/images",n=(localforage,new Firebase(a)),r=s(n),i=document.getElementById("yourInput").files;console.log("files",i),angular.forEach(i,function(a){console.log("for each file",a),e.reader=new FileReader(a),e.reader.onload=function(a){return e.reader.readAsDataURL(a),function(e){console.log("-- RESULT",e.target.result,"-- NAME:",a.name);var s=new Image;s.src=e.target.result,r.$add(s.src).then(function(e){console.log(e.key()),t.media=e.key(),document.getElementById("yourInput").value=null})}}(a)})}}}}]),angular.module("scannabis").config(["$stateProvider","$urlRouterProvider","$compileProvider",function(e,t,a){a.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.state("scannabis.test",{url:"test",template:"<scannabis></scannabis>"}).state("scannabis",{url:"/",template:"<scannabis></scannabis>",controller:["$scope","Data","$state",function(e,t,a){e.data=t,e.state=a,e.local=t.local}]}).state("scannabis.market",{url:"market",template:"<ui-view></ui-view><shop></shop><reviews></reviews>"}).state("scannabis.market.location",{url:"/:location"}).state("scannabis.market.location.shop",{url:"/:shop"}).state("scannabis.market.product",{url:"/:user/:product",template:"<product></product><reviews></reviews>"}).state("scannabis.auth",{url:"auth",template:"<auth></auth>"}).state("scannabis.pos",{url:"pos",template:"<products></products><reviews></reviews>"}).state("scannabis.strains",{url:"strains",template:"<dna></dna>"}).state("scannabis.delivery",{url:"delivery",template:"<delivery></delivery>"}).state("scannabis.news",{url:"news",template:"<news></news>"}).state("scannabis.users",{url:"users",template:"<users></users>"}).state("scannabis.coins",{url:"coins",template:"<coin></coin>"}).state("scannabis.jobs",{url:"jobs",template:"<jobs></jobs>"}).state("scannabis.jobs.job",{url:"/:job",template:"<job></job>"}).state("scannabis.jobs.hires",{url:"jobs",template:"<jobs></jobs>"}),t.otherwise("/")}]);